<!--
  ~ * Copyright (C) GPayments Pty Ltd - All Rights Reserved
  ~ * Copying of this file, via any medium, is subject to the
  ~ * ActiveServer End User License Agreement (EULA)
  ~ *
  ~ * Proprietary code for use in conjunction with GPayments products only
  ~ *
  ~ * Unless required by applicable law or agreed to in writing, software
  ~ * distributed under the License is distributed on an "AS IS" BASIS,
  ~ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ * See the License for the specific language governing permissions and
  ~ * limitations under the License.
  ~ *
  ~ * Written by GPayments <techsupport@gpayments.com>, 2019
  ~
  ~
  -->

<!DOCTYPE html>
<head>
  <meta charset="UTF-8"/>
  <title>3DSecure 2.0 Authentication</title>
  <link rel="stylesheet"
        href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
        crossorigin="anonymous">
  <link rel="stylesheet" href="css/style.css"/>
  <link rel="stylesheet" href="css/spinner.css"/>
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css"
        integrity="sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ"
        crossorigin="anonymous">
</head>
<body>

<!--Retrieve navigation bar using mustache template-->
{{>contents/nav_bar}}

<div class="container">

  <div class="row h-100 card-row">
    <div class="col-sm-9">
      <div class="card" id="checkoutCard">
        <div class="challengeContainer border" id="iframeDiv">
          <div class="spinner row h-100 justify-content-center align-items-center">
            <div class="col">
              <div class="sk-fading-circle">
                <div class="sk-circle1 sk-circle"></div>
                <div class="sk-circle2 sk-circle"></div>
                <div class="sk-circle3 sk-circle"></div>
                <div class="sk-circle4 sk-circle"></div>
                <div class="sk-circle5 sk-circle"></div>
                <div class="sk-circle6 sk-circle"></div>
                <div class="sk-circle7 sk-circle"></div>
                <div class="sk-circle8 sk-circle"></div>
                <div class="sk-circle9 sk-circle"></div>
                <div class="sk-circle10 sk-circle"></div>
                <div class="sk-circle11 sk-circle"></div>
                <div class="sk-circle12 sk-circle"></div>
              </div>
              <div class="text-center"><img class="w-25" id="cardLogo" src="" alt=""/></div>
            </div>
          </div>
        </div>
      </div>

      <!--Result Card -->
      <div class="card d-none" id="resultCard">
        <div class="card-header">Test Results</div>
        <div class="card-body">
          <h4 class="card-title" id="test-result-headline">Test result values are displayed
            below</h4>
          <p class="card-text">These values would generally be used to start the authorisation
            process. Select the "Back" button to restart this process.</p>
          <div id="showResult"></div>
        </div>
      </div>
      <!--Button: show results in separate page-->
      <div id="sepButton" class="d-none">
        <button type="button" class="btn btn-light" onclick="openResultInNewWindow()">Show results
          in separate page &raquo;
        </button>
      </div>
    </div>
    <!--Back Button-->
    <div class="col-sm-3 mb-4">
      <ul class="list-group mb-3">
        <div>
          <a href="/" class="btn btn-primary btn-lg btn-block" id="backButton">
          </a>
        </div>
      </ul>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.3.1.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
<script src="/js/check-credit-card-type.js"></script>
<script src="/js/common.js"></script>
<script src="/js/3ds-web-adapter.js"></script>
<script>

  /**
   * Get sessionData from sessionStorage. SessionData should be stored from your shop or test pages.
   * In this example, sessionData contains:
   *    1. channel: 'brw', '3ri' or 'enrol'
   *    2. authData: all the necessary data in JSON format (For data structure, please refer to the API document).
   *    3. backButtonType: indicate the 'back' button in the process page
   *    4. messageCategory: used in 'brw' channel.
   *       Either 'pa' - payment authentication or 'npa' - non-payment authentication.
   *       Default using 'pa' if user don't specify messageCategory.
   */
  var sessionData = JSON.parse(sessionStorage.getItem("sessionData"));
  console.log("sessionData: ", sessionData);
  if (sessionData.authData.acctNumber) {
    showCardLogo(sessionData.authData.acctNumber);
  }
  changeBackButton(sessionData.backButtonType);

  /**
   * All 3ds2 requests handled in process.html page.
   * Including 'Browser-based authentication (brw)', '3DS Requestor Initiated (3ri)', and 'Enrol".
   */
  switch (sessionData.channel) {
    case "brw":
      var container = $('#iframeDiv');

      //call 'brw()' function in 3ds-web-adapter to perform Browser-based authentication (Step 1)
      //parameters:
      //   authData: data for authentication
      //   container: container object for iframe used in 3ds-web-adapter.
      //   _callbackFn: call back function
      //   messageCategory: 'pa' or 'npa'
      brw(sessionData.authData, container, _callbackFn, sessionData.messageCategory);

      break;
    case "3ri":

      // call 'threeRI()' fucntion in 3ds-web-adapter to perform 3DS Requestor Initiated
      threeRI(sessionData.authData, _callbackFn);

      break;
    case "enrol":
      // call 'enrol()' fucntion in 3ds-web-adapter to perform Enrol
      enrol(sessionData.authData, _callbackFn);

      break;
    default:
      showError({"Error": "Invalid channel"});
      break;
  }

  /**
   * Callback function for 3ds-web-adapter.
   * This function should be implemented by merchant side to handle callback from 3ds-web-adapter.
   * Two parameters expected: type and data.
   * @param type. Indicate the type of event. Values accepted:
   *                    onAuthResult: indicate an auth result
   *                    on3RIResult: indicate an 3ri result
   *                    onEnrolResult: indicate an enrol result
   *                    onChallengeStart: indicate to start a challenge
   *                    onError: indicate an error
   * @param data. The data returned from 3ds-web-adapter. Data contains either the result of 'auth', '3ri', 'enrol', or the error message.
   */
  function _callbackFn(type, data) {

    switch (type) {
      case "onAuthResult":
        //display "Show results in separate page"
        $("#sepButton").removeClass("d-none");
        showResult(data);
        break;

      case "on3RIResult":
        showResult(data);
        break;

      case "onEnrolResult":
        showResult(data);
        break;

      case "onChallengeStart":
        //remove the spinner to show the challenge window
        $(".spinner").remove();
        break;

      case "onError":
        showError(data);
        break;

      default:
        showError({"Error": "Unknown callback type"});
        break;
    }
  }

  function showResult(data) {

    $("#test-result-headline").addClass("text-success");
    showData(data);
  }

  function showError(error) {

    $("#test-result-headline").addClass("text-danger");
    showData(error);
  }

  function showData(data) {
    var toShow = "<dl class='row'>";
    Object.keys(data).forEach(function (k) {
      toShow = toShow + "<dt class='col-sm-4'>" + k + "</dt>" + "<dd class='col-sm-8'>" + data[k]
          + "</dd>";
    });
    toShow += "</dl>";
    $('#showResult').html(toShow);
    $("#checkoutCard").remove();
    $("#resultCard").removeClass("d-none");
  }

  /**
   * call url /result to get result  (Step 15(F) or Step 20(C))
   */
  function openResultInNewWindow() {
    if (serverTransId) {
      var url = '/result';

      sessionStorage.setItem("serverTransId", serverTransId);
      window.open(url, 'newwindow', 'height=800,width=1000');
    }
  }

  /**
   * Change Back Button to go to relative pages
   * @param type
   */
  function changeBackButton(type) {
    var backButton = $('#backButton');
    switch (type) {
      case "toShop":
        backButton.text("Back to Shop").attr("href", "/shop");
        break;

      case "toBrw":
        backButton.text("Back to BRW").attr("href", "/brw");
        break;

      case "toEnrol":
        backButton.text("Back to Enrol").attr("href", "/enrol");
        break;

      case "to3ri":
        backButton.text("Back to 3RI").attr("href", "/3ri");
        break;

      default:
        backButton.text("Back").attr("href", "/");
        break;
    }
  }

  /**
   * Show card logo in the spinner according to the card number
   * @param cardNumber
   */
  function showCardLogo(cardNumber) {
    var cardLogo = $("#cardLogo");
    switch (cc_brand_id(cardNumber)) {
      case "Visa":
        cardLogo.attr("src", "images/visa-logo.png");
        break;
      case "Mastercard":
        cardLogo.attr("src", "images/mastercard-logo.png");
        break;
      case "JCB":
        cardLogo.attr("src", "images/jcb-logo.png");
        break;
      case "AMEX":
        cardLogo.attr("src", "images/amex-logo.png");
        break;
      case "Discover":
        cardLogo.attr("src", "images/discover-logo.png");
        break;
      default:
        cardLogo.attr("src", "");
        break;
    }
  }
</script>
</body>
</html>