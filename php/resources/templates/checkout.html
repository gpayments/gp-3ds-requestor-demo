<!--
  ~ * Copyright (C) GPayments Pty Ltd - All Rights Reserved
  ~ * Copying of this file, via any medium, is subject to the
  ~ * ActiveServer End User License Agreement (EULA)
  ~ *
  ~ * Proprietary code for use in conjunction with GPayments products only
  ~ *
  ~ * Unless required by applicable law or agreed to in writing, software
  ~ * distributed under the License is distributed on an "AS IS" BASIS,
  ~ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ * See the License for the specific language governing permissions and
  ~ * limitations under the License.
  ~ *
  ~ * Written by GPayments <techsupport@gpayments.com>, 2020
  ~
  ~
  -->

<!DOCTYPE html>
<head>
  <meta charset="UTF-8"/>
  <title>3DSecure 2.0 Authentication</title>
  <link rel="stylesheet"
        href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
        crossorigin="anonymous">
  <link rel="stylesheet" href="/css/style.css"/>
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css"
        integrity="sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ"
        crossorigin="anonymous">
</head>
<body>

{{>contents/nav_bar}}

<div class="container">

  <div class="row h-100 card-row">
    <div class="col-lg-9">

      <!--Cardholder Information -->
      <div class="card" id="cardholderInfoCard">
        <div class="card-header">
          Cardholder Information
        </div>

        <div class="card-body">
          <div id="cardholder-info-div">
            <div>

              <h3 class="mb-3">Payment</h3>
              <hr>
              <div>
                <dl class="row">
                  <dt class="col-sm-4">Name on card</dt>
                  <dd class="col-sm-8">
                    <input type="text" id="cardholderName" class="form-control"
                           value="Test Card"
                    />
                  </dd>

                  <dt class="col-sm-4">Card Number</dt>
                  <dd class="col-sm-8">
                    <input type="text" id="acctNumber" class="form-control"
                           value="4100000000000100"
                    />
                  </dd>

                  <dt class="col-sm-4">Expiry Date (YYMM)</dt>
                  <dd class="col-sm-8">
                    <input type="text" id="cardExpiryDate" class="form-control"
                           value=""
                    />
                  </dd>

                  <dt class="col-sm-4">Currency</dt>
                  <dd class="col-sm-8">
                    <input type="text" id="purchaseCurrency" class="form-control"
                           value="036"
                    />
                  </dd>

                </dl>
              </div>


              <div>
                <br>
                <h3 class="card-title">Billing details</h3>
                <hr>
                <dl class="row">

                  <dt class="col-sm-4">Address Line 1</dt>
                  <dd class="col-sm-8">
                    <input type="text" id="billAddrLine1" class="form-control"
                           value="Unit 1"
                    />
                  </dd>
                  <dt class="col-sm-4">Address Line 2</dt>
                  <dd class="col-sm-8">
                    <input type="text" id="billAddrLine2" class="form-control"
                           value="123 Street"
                    />
                  </dd>
                  <dt class="col-sm-4">Address Line 3</dt>
                  <dd class="col-sm-8">
                    <input type="text" id="billAddrLine3" class="form-control"
                           value="123 Suburb"
                    />
                  </dd>
                  <dt class="col-sm-4">City</dt>
                  <dd class="col-sm-8">
                    <input type="text" id="billAddrCity" class="form-control"
                           value="Sydney"
                    />
                  </dd>
                  <dt class="col-sm-4">State</dt>
                  <dd class="col-sm-8">
                    <input type="text" id="billAddrState" class="form-control"
                           value="NSW"
                    />
                  </dd>
                  <dt class="col-sm-4">ZIP</dt>
                  <dd class="col-sm-8">
                    <input type="text" id="billAddrPostCode" class="form-control"
                           value="2000"
                    />
                  </dd>
                  <dt class="col-sm-4">Country Code</dt>
                  <dd class="col-sm-8">
                    <input type="text" id="billAddrCountry" class="form-control"
                           value="036"
                    />
                  </dd>

                </dl>
              </div>

              <hr>
              <div class="row">

                <dt class="col-sm-12">Is this address also your shipping address?</dt>
                <div class="col-sm-1"></div>
                <div class="col-sm-11">
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="shipping-radios"
                           id="shipping-radio-yes"
                           value="option1" onclick="showAdvancedDetails(false)" checked>
                    <label class="form-check-label" for="shipping-radio-yes">
                      Yes
                    </label>
                  </div>
                </div>
                <div class="col-sm-1"></div>
                <div class="col-sm-11">
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="shipping-radios"
                           id="shipping-radio-no"
                           value="option2" onclick="showAdvancedDetails(true)">
                    <label class="form-check-label" for="shipping-radio-no">
                      No
                    </label>
                  </div>
                </div>
              </div>

              <div id="advanced-details" class="d-none">

                <div>
                  <br>
                  <h3 class="card-title">Shipping details</h3>
                  <hr>
                  <d1 class="row">
                    <dt class="col-sm-4">Address Line 1</dt>
                    <dd class="col-sm-8">
                      <input type="text" id="shipAddrLine1" class="form-control"
                             value="Unit 1"
                      />
                    </dd>
                    <dt class="col-sm-4">Address Line 2</dt>
                    <dd class="col-sm-8">
                      <input type="text" id="shipAddrLine2" class="form-control"
                             value="123 Street"
                      />
                    </dd>
                    <dt class="col-sm-4">Address Line 3</dt>
                    <dd class="col-sm-8">
                      <input type="text" id="shipAddrLine3" class="form-control"
                             value="123 Suburb"
                      />
                    </dd>
                    <dt class="col-sm-4">City</dt>
                    <dd class="col-sm-8">
                      <input type="text" id="shipAddrCity" class="form-control"
                             value="Sydney"
                      />
                    </dd>
                    <dt class="col-sm-4">State</dt>
                    <dd class="col-sm-8">
                      <input type="text" id="shipAddrState" class="form-control"
                             value="NSW"
                      />
                    </dd>
                    <dt class="col-sm-4">ZIP</dt>
                    <dd class="col-sm-8">
                      <input type="text" id="shipAddrPostCode" class="form-control"
                             value="2000"
                      />
                    </dd>
                    <dt class="col-sm-4">Country Code</dt>
                    <dd class="col-sm-8">
                      <input type="text" id="shipAddrCountry" class="form-control"
                             value="036"
                      />
                    </dd>
                  </d1>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>

    </div>
    <!--Cart Div-->
    <div class="col-lg-3 mb-4">
      <h4 class="d-flex justify-content-between align-items-center mb-3">
        <span class="text-muted">Your cart</span>
        <span class="badge badge-secondary badge-pill" id="totalPrice">Total $0</span>
      </h4>
      <ul class="list-group mb-3" id="cartItem">
        <li class="list-group-item d-flex justify-content-between">Empty</li>
      </ul>

      <div class="btn-group btn-block" id="do3DS">
        <!--button to do 3ds method-->
      </div>

    </div>
  </div>

</div>

{{>contents/deps}}
<script src="/js/cart.js"></script>
<script>
  showActionButton("checkoutButton", "Checkout", "checkout");

  var itemList = JSON.parse(sessionStorage.getItem("itemList"));
  console.log("get itemList: ", itemList);
  displayCart(itemList);

  function checkout() {
    var apiVersion = getApiVersion();
    switch (apiVersion) {
      case "v1":
        goApiV1();
        break;
      case "v2":
        goApiV2();
        break;
      default:
        goApiV2();
        break;
    }
  }

  function goApiV1() {
    var sessionData = genSessionData();
    sessionData.messageCategory = "pa";
    sessionStorage.setItem("sessionData", JSON.stringify(sessionData));
    window.location.href = "/v1/process";
  }

  function goApiV2() {
    var sessionData = genSessionData();
    sessionData.authData.messageCategory = "pa";
    sessionStorage.setItem("sessionData", JSON.stringify(sessionData));
    window.location.href = "/v2/process";
  }

  function genSessionData() {
    var sessionData = {};
    sessionData.channel = "brw";
    sessionData.authData = genAuthData();
    sessionData.backButtonType = "toShop";
    return sessionData;
  }

  function genAuthData() {
    var authData = {};

    authData.merchantId = "123456789012345";
    authData.authenticationInd = "01";
    authData.purchaseDate = moment().utc().format('YYYYMMDDHHmmss');
    authData.purchaseAmount = getTotalPrice(itemList) * 100; //cent to dollar

    var acctNumber = $('#acctNumber').val();
    if (acctNumber) {
      authData.acctNumber = acctNumber;
    }

    var cardExpiryDate = $('#cardExpiryDate').val();
    if (cardExpiryDate) {
      authData.cardExpiryDate = cardExpiryDate;
    }

    var purchaseCurrency = $('#purchaseCurrency').val();
    if (purchaseCurrency) {
      authData.purchaseCurrency = purchaseCurrency;
    }

    var cardHolderInfo = getCardHolderInfo();
    if (cardHolderInfo) {
      authData.cardHolderInfo = cardHolderInfo
    }

    return authData;
  }

  function getTotalPrice(itemList) {
    var total = 0;
    itemList.forEach(function (item) {
      total += item.price * item.quantity;
    });
    return total;
  }

  $(document).ready(function () {
    var apiVersion = getApiVersion();
    updateActionButtonText(apiVersion, $("#checkoutButton"), "Checkout");

    // Automatic extend date + 1 year for testing purposes
    var expiryDate = moment().add(1, 'year').format('YYMM');
    $('#cardExpiryDate').val(expiryDate);
  });
</script>
</body>
</html>